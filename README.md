# DO NOT USE TESTING IN PROGRESS!

# Stubby-Installer-Asuswrt-Merlin
Stubby DNS Privacy Daemon Install Script for Asuswrt-Merlin Firmware

## Description

[Stubby](https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Daemon+-+Stubby) is an application that acts as a local DNS Privacy stub resolver (using DNS-over-TLS). Stubby encrypts DNS queries sent from a client machine (desktop or laptop) to a DNS Privacy resolver increasing end user privacy.

## Requirements
1. An Asus router with  [Asuswrt-Merlin](http://asuswrt.lostrealm.ca/) firmware installed.
2. A USB drive with entware installed.  Entware can be installed using [amtm - the SNBForum Asuswrt-Merlin Terminal Menu](https://www.snbforums.com/threads/amtm-the-snbforum-asuswrt-merlin-terminal-menu.42415/)

The use of Stubby on Asuswrt-Merlin is experimental and not endorsed by the firmware developer. As an extra precaution, it is highly recommended to take a back-up of the jffs partition and the firmware configuration before proceeding with the installation. You can also use this script to uninstall Stubby and remove the changes made during the installation.   

The Stubby installer script **stubby_installer.sh** will
1. Install the entware packages **stubby** and **ca-certificates**
2. Override how the firmware manages DNS  
3. Default to Cloudflare DNS 1.1.1.1. You can change to other supported DNS over TLS providers by modifying **/opt/etc/stubby/stubby.yml**.
4. Provide the option to remove Stubby and the firmware DNS overrides.

## Installation
Copy and paste the command below into an SSH session.
```javascript
/usr/sbin/curl --retry 3 "https://raw.githubusercontent.com/Xentrk/Stubby-Installer-Asuswrt-Merlin/master/install_stubby.sh" -o /jffs/scripts/install_stubby.sh && chmod 755 /jffs/scripts/install_stubby.sh && sh /jffs/scripts/install_stubby.sh
```

## Validating that Stubby is Working
Run the following commands from an SSH session to verify that stubby is working properly:

    ps | grep stubby | grep -v grep
    netstat -lnptu | grep stubby
    drill github.com (requires entware package drill)
    nslookup github.com
    echo | openssl s_client -connect '1.1.1.1:853'

Check the last few lines of the output from the **echo | openssl s_client -connect '1.1.1.1:853'** command.  If you see the message

    Verify return code: 20 (unable to get local issuer certificate)

in the last few lines, enter the following command:

    echo | openssl s_client -verify on -CApath /opt/etc/ssl/certs -connect  1.1.1.1:853

Use the [Cloudflare Help Page](https://1.1.1.1/help) to validate you are connected to 1.1.1.1 and **DNS over TLS** is working.  If working properly, the page will display a **Yes** as seen in the example below:

    Connected to 1.1.1.1         Yes
    Using DNS over HTTPS (DoH)   No
    Using DNS over TLS (DoT)     Yes
## Starting, Stopping and Killing Stubby
To **(start|stop|restart|check|kill|reconfigure)** stubby, type the command below where **option** is one of the options listed in the parenthesis.

    /opt/etc/init.d/S61stubby option

## DNSSEC
**this section is being worked on**

The install script turns off the DNSSEC setting on the firmware to avoid conflicts with DNSSEC built into Stubby. The [Cloudflare Help Page](https://1.1.1.1/help) does not support DNSSEC.  The site will give a false result when using DNSSEC. The default **stubby.yml** configuration file from the install script will fail the DNSSEC Test websites listed below. If you want to experiment with DNSSEC when using Cloudflare, you can copy the  **stubby.yml.dnssec** file contents to **/opt/etc/stubby/stubby.yml**, followed by a restart of Stubby using the command **/opt/etc/init.d/S61stubby restart**.

## DNS Test Web Sites
1. DNSSEC Test

  * https://rootcanary.org/test.html
  * http://dnssec.vs.uni-due.de/
  * http://en.conn.internet.nl/connection/

2. DNS Spoof and Entrophy Test
  * https://www.grc.com/dns/dns.htm (scroll down and click on "Initiate Standard DNS Spoofability Test")
  *	https://www.dns-oarc.net/oarc/services/dnsentropy

3. DNS Leak Test

  * https://www.dnsleaktest.com/ (use Extended test)
  *	https://ipleak.net/

4. WebRTC Leak Test

  * https://browserleaks.com/webrtc
  * https://ip8.com/webrtc-test
  * https://ipx.ac/run
  * https://www.perfect-privacy.com/check-ip/
  * https://www.doileak.com/

## Collaborators

* [Martineau](https://www.snbforums.com/members/martineau.13215/) on snbforums.com provided the **Chk_Entware** function.

* [John9527](https://www.snbforums.com/members/john9527.27638/) is the developer of the [Asuswrt-Merlin Fork](https://github.com/john9527/asuswrt-merlin). **John9527** implemented Stubby in August 2018 and provided the **stubby.yml** configuration generated by the firmware **Asuswrt-Merlin-Fork**. The **stubby.yml** provided by **John9527** was used as a benchmark for this project.  My goal is to standardize the configurations used in the [Asuswrt-Merlin Fork](https://github.com/john9527/asuswrt-merlin) when possible.     

* Thank you to snbforum members [@skeal](https://www.snbforums.com/members/skeal.47960/) and [@M@rco](https://www.snbforums.com/members/m-rco.56284/) who volunteered their time performing testing and providing feedback.

## Support

Support for the project is available on snbforums.com (Link Coming Soon)
